<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HISOBA 動画作成ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap');

        body { font-family: 'Noto Sans JP', sans-serif; }

        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #4f46e5;
            width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .drop-zone { transition: all 0.3s ease; }
        .drop-zone.dragover { border-color: #4f46e5; background-color: #eef2ff; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen">

    <header class="bg-slate-900 text-white sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex-shrink-0 flex items-center">
                    <a href="index.html" class="font-black text-2xl tracking-tighter text-white">HISOBA</a>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow flex items-center justify-center p-4">
        <div class="w-full max-w-3xl bg-white rounded-2xl shadow-2xl overflow-hidden my-8">
            <div class="bg-indigo-600 p-6 text-white text-center relative">
                <h1 class="text-2xl font-bold tracking-wider"><i class="fas fa-wand-magic-sparkles mr-2"></i>自動最適化 広告動画ツール</h1>
            </div>

            <div class="p-6 md:p-8 space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex flex-col gap-2">
                        <label class="font-bold text-gray-700 block">
                            <span class="bg-gray-800 text-white px-2 py-0.5 rounded text-sm mr-2">Step 1</span>帯（バナー）画像
                        </label>
                        <div id="zone-img" class="drop-zone border-2 border-dashed border-gray-300 rounded-xl h-48 flex flex-col items-center justify-center bg-gray-50 cursor-pointer hover:border-indigo-500 hover:bg-indigo-50 relative group transition-colors">
                            <input type="file" id="file-img" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            <div id="preview-img-box" class="hidden w-full h-full flex items-center justify-center p-2">
                                <img id="preview-img" class="max-h-full max-w-full object-contain shadow-sm rounded">
                            </div>
                            <div id="placeholder-img" class="pointer-events-none text-center group-hover:scale-105 transition-transform">
                                <i class="fas fa-image text-3xl text-gray-400 mb-2 group-hover:text-indigo-400"></i>
                                <p class="text-sm text-gray-500 font-bold">画像をドロップ</p>
                                <p class="text-xs text-gray-400 mt-1">全体を表示します（見切れなし）</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col gap-2">
                        <label class="font-bold text-gray-700 block">
                            <span class="bg-indigo-600 text-white px-2 py-0.5 rounded text-sm mr-2">Step 2</span>本編動画
                        </label>
                        <div id="zone-vid" class="drop-zone border-2 border-dashed border-gray-300 rounded-xl h-48 flex flex-col items-center justify-center bg-gray-50 cursor-pointer hover:border-indigo-500 hover:bg-indigo-50 relative group transition-colors">
                            <input type="file" id="file-vid" accept="video/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            <div id="preview-vid-box" class="hidden w-full h-full flex items-center justify-center p-2">
                                <video id="preview-vid" class="max-h-full max-w-full object-contain shadow-sm rounded"></video>
                            </div>
                            <div id="placeholder-vid" class="pointer-events-none text-center group-hover:scale-105 transition-transform">
                                <i class="fas fa-video text-3xl text-gray-400 mb-2 group-hover:text-indigo-400"></i>
                                <p class="text-sm text-gray-500 font-bold">動画をドロップ</p>
                                <p class="text-xs text-gray-400 mt-1">形に合わせて自動調整します</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center pt-2">
                    <button id="create-btn" disabled class="bg-gray-300 cursor-not-allowed text-white font-bold py-4 px-12 rounded-full shadow-lg transition duration-300 flex items-center gap-3 text-lg w-full md:w-auto justify-center transform active:scale-95">
                        <i class="fas fa-layer-group"></i> 広告動画を作成する
                    </button>
                </div>

                <div id="progress-area" class="hidden space-y-4 bg-white p-6 rounded-xl border-2 border-indigo-100 shadow-inner">
                    <div class="flex justify-between items-center">
                        <div>
                            <span id="status-text" class="font-bold text-indigo-800 text-lg">処理準備中...</span>
                            <p class="text-xs text-gray-500 mt-1">※ブラウザを閉じないでください</p>
                        </div>
                        <div class="loader"></div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                        <div id="progress-bar" class="bg-indigo-600 h-3 rounded-full transition-all duration-300 shadow-[0_0_10px_rgba(79,70,229,0.5)]" style="width: 0%"></div>
                    </div>
                    <canvas id="canvas" class="hidden"></canvas>
                </div>

                <div id="result-area" class="hidden bg-green-50 p-6 rounded-xl border border-green-200 text-center animate-fade-in">
                    <h3 class="text-xl font-bold text-green-800 mb-4"><i class="fas fa-check-circle mr-2"></i>動画が完成しました！</h3>
                    <div id="result-info" class="text-sm text-gray-600 mb-2 font-bold"></div>
                    <video id="result-video" controls class="w-full max-h-80 bg-black rounded-lg mb-6 mx-auto shadow-lg border border-gray-300"></video>
                    <div class="flex flex-col md:flex-row justify-center gap-4">
                        <a id="download-btn" href="#" download="ad_video.webm" class="inline-flex items-center justify-center bg-green-600 text-white font-bold py-3 px-8 rounded-full hover:bg-green-700 transition shadow-lg transform hover:-translate-y-1">
                            <i class="fas fa-download mr-2"></i> <span id="dl-text">保存する</span>
                        </a>
                    </div>
                </div>

                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r shadow-sm mt-8">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 mt-0.5"><i class="fas fa-circle-info text-blue-500 text-base"></i></div>
                        <div class="ml-3 w-full">
                            <h2 class="text-blue-800 font-bold text-sm mb-2 border-b border-blue-200 pb-1">■ 自動レイアウト仕様</h2>
                            <p class="text-xs text-gray-700 mb-1">
                                <span class="font-bold text-blue-700">横長・正方形の動画:</span>
                                全体を<span class="font-bold">正方形 (1:1)</span> で出力します。
                            </p>
                            <p class="text-xs text-gray-700 mb-1">
                                <span class="font-bold text-blue-700">縦長の動画:</span>
                                全体を<span class="font-bold">縦長 (4:5)</span> で出力します。
                            </p>
                            <p class="text-xs text-gray-500 mt-2">
                                ※画像は縮小して全体を表示します（見切れなし）。
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const els = {
            fImg: document.getElementById('file-img'),
            fVid: document.getElementById('file-vid'),
            btn: document.getElementById('create-btn'),
            pImg: document.getElementById('preview-img'),
            pVid: document.getElementById('preview-vid'),
            status: document.getElementById('status-text'),
            bar: document.getElementById('progress-bar'),
            result: document.getElementById('result-video'),
            resInfo: document.getElementById('result-info'),
            dl: document.getElementById('download-btn'),
            dlText: document.getElementById('dl-text'),
            canvas: document.getElementById('canvas'),
            progArea: document.getElementById('progress-area'),
            resArea: document.getElementById('result-area')
        };

        let fileImg = null;
        let fileVid = null;
        let isProcessing = false;

        function updateUI() {
            if (fileImg && fileVid && !isProcessing) {
                els.btn.disabled = false;
                els.btn.classList.remove('bg-gray-300', 'cursor-not-allowed');
                els.btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'cursor-pointer');
            }
        }

        els.fImg.addEventListener('change', e => {
            if (e.target.files[0]) {
                fileImg = e.target.files[0];
                els.pImg.src = URL.createObjectURL(fileImg);
                document.getElementById('placeholder-img').classList.add('hidden');
                document.getElementById('preview-img-box').classList.remove('hidden');
                document.getElementById('zone-img').classList.add('border-indigo-500', 'bg-indigo-50');
                updateUI();
            }
        });

        els.fVid.addEventListener('change', e => {
            if (e.target.files[0]) {
                fileVid = e.target.files[0];
                els.pVid.src = URL.createObjectURL(fileVid);
                els.pVid.currentTime = 0.1; 
                document.getElementById('placeholder-vid').classList.add('hidden');
                document.getElementById('preview-vid-box').classList.remove('hidden');
                document.getElementById('zone-vid').classList.add('border-indigo-500', 'bg-indigo-50');
                updateUI();
            }
        });

        // --- メイン処理 ---
        els.btn.addEventListener('click', async () => {
            if (!fileImg || !fileVid || isProcessing) return;
            isProcessing = true;
            els.btn.disabled = true;
            els.btn.classList.add('bg-gray-300', 'cursor-not-allowed');
            els.progArea.classList.remove('hidden');
            els.resArea.classList.add('hidden');

            let procVid = null;
            let ac = null;

            try {
                const img = await new Promise((resolve, reject) => {
                    const i = new Image(); i.onload = () => resolve(i); i.onerror = reject; i.src = URL.createObjectURL(fileImg);
                });
                
                procVid = await new Promise((resolve, reject) => {
                    const v = document.createElement('video');
                    v.playsInline = true; v.webkitPlaysInline = true; v.setAttribute('playsinline', '');
                    v.muted = false; v.crossOrigin = 'anonymous';
                    v.style.position = 'fixed'; v.style.top = '-9999px'; v.style.left = '-9999px'; v.style.opacity = '0'; v.style.pointerEvents = 'none';
                    document.body.appendChild(v);
                    v.onloadedmetadata = () => resolve(v); v.onerror = reject; v.src = URL.createObjectURL(fileVid);
                });

                // === レイアウト計算 ===
                const vidW = procVid.videoWidth;
                const vidH = procVid.videoHeight;
                
                let canvasW = Math.max(vidW, 1080);
                if (canvasW % 2 !== 0) canvasW += 1;
                
                let canvasH;
                let layoutMode = "";

                if (vidH > vidW) {
                    canvasH = canvasW * 1.25; // 4:5
                    layoutMode = "縦長 (4:5) モード";
                } else {
                    canvasH = canvasW; // 1:1
                    layoutMode = "正方形 (1:1) モード";
                }
                
                canvasH = Math.floor(canvasH);
                if (canvasH % 2 !== 0) canvasH += 1;

                els.canvas.width = canvasW;
                els.canvas.height = canvasH;
                const ctx = els.canvas.getContext('2d');

                // A. 画像エリア（下1/4）
                const bannerW = canvasW;
                const bannerH = canvasH / 4; 
                const bannerX = 0;
                const bannerY = canvasH - bannerH;

                // B. 動画エリア（残りの上部3/4）
                const availW = canvasW;
                const availH = bannerY; 
                
                const scaleW = availW / vidW;
                const scaleH = availH / vidH;
                const vidScale = Math.min(scaleW, scaleH);
                
                const drawVidW = vidW * vidScale;
                const drawVidH = vidH * vidScale;
                const drawVidX = (availW - drawVidW) / 2;
                const drawVidY = (availH - drawVidH) / 2;

                // 音声処理
                const AC = window.AudioContext || window.webkitAudioContext;
                ac = new AC();
                const dest = ac.createMediaStreamDestination();
                const vNode = ac.createMediaElementSource(procVid);
                vNode.connect(dest);

                const stream = els.canvas.captureStream(30);
                if (dest.stream.getAudioTracks().length > 0) {
                    stream.addTrack(dest.stream.getAudioTracks()[0]);
                }

                let mimeType = 'video/webm;codecs=vp9';
                let ext = 'webm';
                if (MediaRecorder.isTypeSupported('video/mp4')) { mimeType = 'video/mp4'; ext = 'mp4'; }
                else if (MediaRecorder.isTypeSupported('video/webm;codecs=h264')) { mimeType = 'video/webm;codecs=h264'; ext = 'webm'; }

                const recorder = new MediaRecorder(stream, { mimeType: mimeType, videoBitsPerSecond: 8000000 });
                const chunks = [];
                recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
                
                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    els.result.src = url; els.dl.href = url;
                    els.dl.download = `ad_video_${layoutMode.includes("縦") ? "portrait" : "square"}.${ext}`;
                    els.dlText.textContent = `保存する (${ext.toUpperCase()})`;
                    els.resInfo.textContent = `出力サイズ: ${canvasW}x${canvasH} [${layoutMode}]`;
                    els.progArea.classList.add('hidden'); els.resArea.classList.remove('hidden');
                    isProcessing = false;
                    if (procVid && procVid.parentNode) procVid.parentNode.removeChild(procVid);
                    if (ac) ac.close();
                };

                recorder.start();
                ac.resume();
                els.status.textContent = `生成中: ${layoutMode}`;
                await procVid.play();

                await new Promise(resolve => {
                    const draw = () => {
                        if (procVid.paused || procVid.ended) { resolve(); return; }

                        // 1. 黒背景
                        ctx.fillStyle = '#000000';
                        ctx.fillRect(0, 0, canvasW, canvasH);

                        // 2. 動画描画
                        ctx.drawImage(procVid, drawVidX, drawVidY, drawVidW, drawVidH);

                        // 3. 画像描画（Containモード: 全体を表示）
                        // 枠(bannerW, bannerH)に対して、画像(img)を縮小してフィットさせる計算
                        const iScale = Math.min(bannerW / img.width, bannerH / img.height);
                        const iDrawW = img.width * iScale;
                        const iDrawH = img.height * iScale;
                        const iDrawX = bannerX + (bannerW - iDrawW) / 2;
                        const iDrawY = bannerY + (bannerH - iDrawH) / 2;

                        ctx.drawImage(img, iDrawX, iDrawY, iDrawW, iDrawH);

                        const progress = (procVid.currentTime / procVid.duration) * 100;
                        els.bar.style.width = `${Math.min(progress, 99)}%`;
                        requestAnimationFrame(draw);
                    };
                    draw();
                    procVid.onended = resolve;
                });

                els.status.textContent = "仕上げ処理中...";
                els.bar.style.width = "100%";
                await new Promise(r => setTimeout(r, 200));
                recorder.stop();

            } catch (e) {
                console.error(e);
                alert("エラーが発生しました: " + e.message);
                isProcessing = false;
                els.progArea.classList.add('hidden');
                els.btn.disabled = false;
                els.btn.classList.remove('bg-gray-300', 'cursor-not-allowed');
                if (procVid && procVid.parentNode) procVid.parentNode.removeChild(procVid);
                if (ac) ac.close();
            }
        });
    </script>
</body>
</html>